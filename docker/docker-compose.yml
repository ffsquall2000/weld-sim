# docker-compose.yml -- FEniCSx solver worker deployment
# Usage:
#   docker compose -f docker/docker-compose.yml up --build
#
# The solver-b service runs the FastAPI worker on port 8002.
# The exchange volume (/tmp/weld-sim-fea-exchange) is shared between the
# host and the container for one-shot script execution via FEniCSxRunner.
# -----------------------------------------------------------
version: "3.9"

services:
  solver-b:
    build:
      context: .
      dockerfile: Dockerfile.fenics
    container_name: fenics-solver-worker
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      - FENICS_WORKER_PORT=8002
      - FENICS_LOG_LEVEL=info
      - MESH_DATA_DIR=/data/meshes
      - FENICS_MAX_DOF=5000000
      - EXCHANGE_DIR=/exchange
    volumes:
      - mesh-data:/data/meshes
      - ${WELD_SIM_EXCHANGE:-/tmp/weld-sim-fea-exchange}:/exchange
    networks:
      - weld-sim-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3

volumes:
  mesh-data:
    driver: local

networks:
  weld-sim-net:
    driver: bridge
